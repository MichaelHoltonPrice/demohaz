% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/usher3.R
\name{temper_and_tune_usher3}
\alias{temper_and_tune_usher3}
\title{Use parallel tempering to fit the usher3 model.}
\usage{
temper_and_tune_usher3(
  th0 = c(0.01, 1, 0.175, 1.4, 0.368 * 0.01, log(0.917 * 0.1/(0.075 * 0.001))/(0.917 *
    0.1), 0.917 * 0.1),
  verbose = FALSE,
  fn_plot = NULL,
  num_cyc = 100,
  samps_per_cyc = 20,
  temp_vect = 10^(rev(seq(-1, 1, by = 0.25))),
  prop_scale_mat = NULL,
  func_tol = 1e-06,
  miniter = 1,
  maxiter = 1000,
  report_period = 50,
  use_gompertz = FALSE,
  tune = TRUE,
  control = list(maxit = 10000, reltol = 1e-12, abstol = 1e-12),
  ...
)
}
\arguments{
\item{th0}{The initial parameter vector with the ordering [k1, k2, b_siler]
where b_siler uses the demohaz parameterization of the Siler hazard (see
Siler documentation)}

\item{verbose}{Whether to print verbose output [default: FALSE]}

\item{fn_plot}{The function for plotting [default: NULL]}

\item{num_cyc}{The number of cycles for tempering [default: 100]}

\item{samps_per_cyc}{The number of samples per cycle [default: 20]}

\item{temp_vect}{The temperature vector for tempering
[default: 10^(rev(seq(-1, 1, by = 0.25)))]}

\item{prop_scale_mat}{The proposal scaling matrix [default: NULL]}

\item{func_tol}{The tolerance for the objective function [default: 1e-6]}

\item{miniter}{The minimum number of iterations [default: 1]}

\item{maxiter}{The maximum number of iterations [default: 1000]}

\item{report_period}{The reporting period for verbose output [default: 50]}

\item{use_gompertz}{Whether to use Gompertz-Makeham mortality [default: FALSE]}

\item{tune}{Whether to perform Nelder-Mead tuning after tempering [default: TRUE]}

\item{control}{Control parameters for optim() when tune=TRUE 
[default: list(maxit = 10000, reltol = 1e-12, abstol = 1e-12)]. 
See ?optim for available options.}

\item{...}{Additional arguments passed to the objective function
(\code{\link{nll_usher3}}), including x (ages-at-death vector),
ill (illness indicators), x0 (conditional starting age, default 0),
and x_cut (age cutoff for transitions, default Inf)}
}
\value{
A list with components:
  \describe{
    \item{obj_fun}{The objective function used (nll_usher3_optim_wrapper)}
    \item{th0}{The initial parameter vector}
    \item{optional_inputs}{List of optional arguments used}
    \item{temper}{Full output from par_temper}
    \item{th_temper}{Best parameter vector from tempering (natural scale)}
    \item{optim_result}{Output from optim() (only when tune=TRUE)}
    \item{th_bar}{Best log-transformed parameter vector (only when tune=TRUE)}
    \item{th}{Best parameter vector on the natural scale (final result)}
  }
}
\description{
If the flag use_gompertz is True, then the infant mortality hazard is
assumed to be zero and the parameter vector, th0, should only have five
terms (k1, k2, and three mortality parameters). If necessary, th0 is subset
from 7 to 5 terms if use_gompertz is TRUE. If the scaling matrix,
prop_scale_mat, is specified when use_gompertz is True its dimensions must
match the reduced length of the parameter vector.
}
\details{
Fitting proceeds in two stages, both operating on the log-transformed
parameter space (th_bar = log(th)) so that all parameters are
unconstrained:

1. **Parallel tempering**: Runs \code{\link{par_temper}} with multiple
   temperature chains to explore the parameter space broadly and avoid
   local minima. The best parameter vector across all chains is selected.

2. **Nelder-Mead tuning** (when tune=TRUE): Refines the tempering result
   using \code{\link[stats]{optim}} with method "Nelder-Mead" and tight
   convergence tolerances. This polishes the solution to high precision.

If prop_scale_mat is NULL, a default proposal scaling matrix is
constructed from the initial parameter vector, with scales ranging from
0.001 to 0.1 across the temperature ladder.
}
\examples{
\dontrun{
b_siler <- c(0.175, 1.40, 0.00368, 38.1, 0.0917)
th <- c(0.02, 1.2, b_siler)
samp <- sample_usher3(1000, th, 0.01, 120)
result <- temper_and_tune_usher3(th, x = samp$x, ill = samp$ill)
result$th  # recovered parameters
}

}
